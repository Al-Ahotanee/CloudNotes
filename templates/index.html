<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CloudNotes Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script>
    tailwind.config = { theme: { extend: { colors: { primary: "#667eea", accent: "#764ba2" }}}};
  </script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-indigo-900 text-white min-h-screen">

{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="fixed top-4 right-4 z-50 space-y-3">
      {% for cat, msg in messages %}
        <div class="bg-{{'green' if cat=='success' else 'red' if cat=='error' else 'blue'}}-600 px-6 py-3 rounded-xl shadow-2xl flex items-center gap-3 animate-pulse">
          <i class="fas fa-{{'check' if cat=='success' else 'times'}}"></i> {{ msg }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if not user %}
  <!-- LANDING + LOGIN -->
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="max-w-4xl w-full">
      <div class="text-center mb-12">
        <h1 class="text-7xl font-black mb-4 bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">CloudNotes Pro</h1>
        <p class="text-2xl opacity-90">The Ultimate Academic Notes Sharing Platform</p>
      </div>

      <div class="grid md:grid-cols-2 gap-8 max-w-3xl mx-auto">
        <form method="POST" action="/login" class="bg-white/10 backdrop-blur-lg rounded-3xl p-10 border border-white/20">
          <h2 class="text-3xl font-bold mb-8 text-center">Login</h2>
          <input name="username" placeholder="Username" required class="w-full px-6 py-4 rounded-xl bg-white/10 border border-white/30 focus:border-pink-500 outline-none mb-4"/>
          <input name="password" type="password" placeholder="Password" required class="w-full px-6 py-4 rounded-xl bg-white/10 border border-white/30 focus:border-pink-500 outline-none mb-6"/>
          <button class="w-full bg-gradient-to-r from-pink-500 to-violet-500 py-4 rounded-xl font-bold text-xl hover:scale-105 transition">Login</button>
          <p class="text-center mt-4 opacity-80">Demo: admin / admin123</p>
        </form>

        <form method="POST" action="/register" class="bg-white/10 backdrop-blur-lg rounded-3xl p-10 border border-white/20">
          <h2 class="text-3xl font-bold mb-8 text-center">Register</h2>
          <input name="username" placeholder="Username" required class="w-full px-6 py-4 rounded-xl bg-white/10 border border-white/30 focus:border-pink-500 outline-none mb-4"/>
          <input name="email" type="email" placeholder="Email" required class="w-full px-6 py-4 rounded-xl bg-white/10 border border-white/30 focus:border-pink-500 outline-none mb-4"/>
          <input name="password" type="password" placeholder="Password" required class="w-full px-6 py-4 rounded-xl bg-white/10 border border-white/30 focus:border-pink-500 outline-none mb-6"/>
          <button class="w-full bg-gradient-to-r from-violet-500 to-indigo-500 py-4 rounded-xl font-bold text-xl hover:scale-105 transition">Create Account</button>
        </form>
      </div>
    </div>
  </div>
{% else %}
  <!-- DASHBOARD -->
  <nav class="bg-black/30 backdrop-blur-lg border-b border-white/10 sticky top-0 z-40">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-pink-500 to-violet-500">CloudNotes</h1>
      <div class="flex items-center gap-6">
        <span>Welcome, <strong>{{ user }}</strong></span>
        <a href="/logout" class="bg-red-600 px-6 py-2 rounded-xl hover:scale-105 transition">Logout</a>
      </div>
    </div>
  </nav>

  <div class="max-w-7xl mx-auto p-6">
    <!-- Search & Filters -->
    <form class="mb-8 bg-white/10 backdrop-blur-lg rounded-3xl p-6 border border-white/20">
      <div class="grid md:grid-cols-4 gap-4">
        <input name="q" value="{{ q }}" placeholder="Search notes..." class="px-6 py-4 rounded-xl bg-white/10 border border-white/30 focus:border-pink-500 outline-none"/>
        <select name="cat" class="px-6 py-4 rounded-xl bg-white/10 border border-white/30 focus:border-pink-500 outline-none">
          {% for c in categories %}<option {{ 'selected' if c==cat else '' }}>{{ c }}</option>{% endfor %}
        </select>
        <select name="sort" class="px-6 py-4 rounded-xl bg-white/10 border border-white/30">
          <option value="recent" {{ 'selected' if sort=='recent' }}>Recent</option>
          <option value="popular" {{ 'selected' if sort=='popular' }}>Popular</option>
          <option value="rating" {{ 'selected' if sort=='rating' }}>Top Rated</option>
        </select>
        <button class="bg-gradient-to-r from-pink-500 to-violet-500 px-8 py-4 rounded-xl font-bold hover:scale-105 transition">Search</button>
      </div>
    </form>

    <div class="grid lg:grid-cols-2 gap-8">
      <!-- Upload Card -->
      <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-8 border border-white/20">
        <h2 class="text-3xl font-bold mb-6">Upload New Note</h2>
        <form method="POST" action="/upload" enctype="multipart/form-data">
          <input name="title" placeholder="Title" required class="w-full mb-4 px-6 py-4 rounded-xl bg-white/10 border border-white/30"/>
          <div class="grid grid-cols-2 gap-4 mb-4">
            <input name="category" placeholder="Category" required class="px-6 py-4 rounded-xl bg-white/10 border"/>
            <input name="subject" placeholder="Subject" required class="px-6 py-4 rounded-xl bg-white/10 border"/>
          </div>
          <textarea name="desc" placeholder="Description (optional)" class="w-full mb-4 px-6 py-4 rounded-xl bg-white/10 border" rows="3"></textarea>
          <input name="tags" placeholder="Tags (comma separated)" class="w-full mb-4 px-6 py-4 rounded-xl bg-white/10 border"/>
          <input type="file" name="file" required class="w-full mb-6 file:mr-4 file:py-3 file:px-6 file:rounded-xl file:border-0 file:bg-gradient-to-r file:from-pink-500 file:to-violet-500"/>
          <button class="w-full bg-gradient-to-r from-green-500 to-emerald-600 py-5 rounded-xl text-xl font-bold hover:scale-105 transition">Upload Note</button>
        </form>
      </div>

      <!-- Notes Grid -->
      <div>
        {% for note in notes %}
          <div class="bg-white/10 backdrop-blur-lg rounded-3xl p-6 mb-6 border border-white/20 hover:scale-[1.02] transition">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-2xl font-bold">{{ note.title }}</h3>
                <p class="opacity-80">{{ note.subject }} • {{ note.category }}</p>
              </div>
              <div class="text-right">
                <div class="text-3xl font-black text-yellow-400">{{ "%.1f"|format(note.avg|default(0)) }} ★</div>
                <div class="text-sm opacity-70">{{ note.downloads }} downloads</div>
              </div>
            </div>
            <p class="mb-4 opacity-90">{{ note.description or "No description" }}</p>
            <div class="flex flex-wrap gap-2 mb-4">
              {% for tag in note.tags|fromjson %}
                <span class="bg-pink-500/30 px-4 py-2 rounded-full text-sm">{{ tag }}</span>
              {% endfor %}
            </div>
            <div class="flex gap-3 flex-wrap">
              <a href="/download/{{ note.id }}" class="bg-gradient-to-r from-green-500 to-emerald-600 px-6 py-3 rounded-xl font-bold hover:scale-110 transition">Download</a>
              
              <form method="POST" action="/rate/{{ note.id }}" class="flex gap-2 items-center">
                <select name="rating" class="bg-white/20 rounded px-3 py-2">
                  <option>1</option><option>2</option><option>3</option><option>4</option><option selected>5</option>
                </select>
                <button class="bg-yellow-500 text-black px-4 py-2 rounded-xl font-bold">Rate</button>
              </form>
              
              {% if note.uploader == user or session.role == 'admin' %}
                <a href="/delete/{{ note.id }}" onclick="return confirm('Delete?')" class="bg-red-600 px-6 py-3 rounded-xl font-bold hover:scale-110 transition">Delete</a>
              {% endif %}
            </div>
          </div>
        {% else %}
          <div class="text-center py-20 text-3xl opacity-50">No notes found</div>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}

<script>
  setTimeout(() => document.querySelectorAll('.fixed').forEach(e => e.remove()), 4000);
</script>
</body>
    </html>
